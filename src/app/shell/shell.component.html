<div class="app">
  <!-- Header -->
  <header aria-label="Oldal fejl√©c">
    <div
      style="
        max-width: 1280px;
        margin: auto;
        display: flex;
        width: id;
        width: 100%;
        justify-content: space-between;
      "
    >
      <div class="brand" title="AI HUB">
        <!-- <div>
          <h1>AI HUB ‚Ä¢ SimplyFire AI HUB</h1>
          <small
            >Modell‚Äë, eszk√∂z‚Äë √©s konnektorf√ºggetlen MI agent
            keretrendszer</small
          >
        </div> -->
      </div>
      <div class="actions">
        <!--       <button pButton type="button" label="Regisztr√°ci√≥" class="p-button-outlined p-button-sm"></button>
      <button pButton type="button" label="Bejelentkez√©s" class="p-button-sm accent button--bordered" iconPos="right" ></button> -->
        <button
          pButton
          type="button"
          class="p-button-text p-button-rounded"
          style="font-size: 20px"
          icon="pi pi-telegram"
          stlye="box-shadow: none;"
          (click)="startNewChat()"
          [attr.aria-label]="'√öj besz√©lget√©s'"
          title="√öj besz√©lget√©s ind√≠t√°sa"
        ></button>
        <button
          pButton
          type="button"
          class="p-button-text p-button-rounded"
          style="font-size: 20px; box-shadow: none;"
          [icon]="isRightAsideOpen() ? 'pi pi-eye-slash' : 'pi pi-cog'"
          (click)="toggleRightAside()"
          [attr.aria-label]="
            isRightAsideOpen()
              ? 'Be√°ll√≠t√°sok bez√°r√°sa'
              : 'Be√°ll√≠t√°sok megnyit√°sa'
          "
          title="Munkat√°rs be√°ll√≠t√°sok"
        ></button>
        <button
          pButton
          type="button"
        
          style="font-size: 20px; box-shadow: none;"
          class="p-button-text p-button-rounded"
          [icon]="themeIcon()"
          (click)="toggleTheme()"
          [attr.aria-label]="themeLabel()"
        ></button>
      </div>
    </div>
  </header>

  <!-- Main grid: Left (agents + accordion chats), Center (thread), Right (settings) -->
  <main class="" style="width: 100vw">
    <!-- Top row: Left aside, Section (middle), Right aside -->
    <div class="top-row">
      <!-- LEFT: Munkat√°rsak + Leny√≠l√≥ besz√©lget√©sek -->
      <aside
        class="panel"
        style="max-width: 400px; width: 400px"
        id="leftCol"
        aria-label="Munkat√°rsak panel"
      >
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-left: 14px;
          "
        >
          <span class="flame" aria-hidden="true"></span>
          <input
            pInputText
            style="
              height: 40px;

              border-radius: 8px;
              padding: 0 10px;
            "
            type="text"
            placeholder="Keres√©s a besz√©lget√©sekben‚Ä¶"
            aria-label="Keres√©s"
          />
          <h2>
            <span class="heading">El≈ëzm√©nyek</span>
          </h2>
          <div class="content">
            <div
              class="list"
              id="agentList"
              role="listbox"
              aria-label="Munkat√°rs lista"
            >
              @if (isLoadingAgents()) {
              <div class="flex flex-column gap-2">
                <div class="agent" style="opacity: 0.6">
                  <div class="av">‚è≥</div>
                  <div class="meta">
                    <div class="title">Bet√∂lt√©s...</div>
                    <div class="sub">Munkat√°rsak bet√∂lt√©se folyamatban</div>
                  </div>
                </div>
              </div>
              } @else {
              <div class="flex flex-column gap-2">
                @for (task of tasksWithAgents(); track task.id) {
                <!-- Task -->
                <div
                  class="task-item"
                  [class.active]="task.id === activeTaskId()"
                  (click)="setActiveTask(task.id)"
                  [attr.aria-label]="'Feladat: ' + task.title"
                  tabindex="0"
                >
                  <div class="task-header">
                    <div class="task-icon">üìã</div>
                    <div class="task-meta">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-sub">
                        {{ task.status }} ‚Ä¢ {{ task.agents.length }} agent
                      </div>
                    </div>
                    <span class="badge task-badge">FELADAT</span>
                  </div>
                </div>

                <!-- Agents under this task -->
                @if (task.id === activeTaskId()) { @for (agent of task.agents;
                track agent.id) {
                <div
                  class="agent task-agent"
                  [class.active]="agent.id === activeAgentId()"
                  (click)="setActiveAgent(agent.id)"
                  [attr.aria-label]="'Munkat√°rs: ' + agent.name"
                  tabindex="0"
                >
                  <div class="av">{{ agent.name?.[0] | uppercase }}</div>
                  <div class="meta">
                    <div class="title">{{ agent.name }}</div>
                    <div class="sub">{{ agent.role }} ‚Ä¢ {{ agent.status }}</div>
                  </div>
              <!--     <span class="badge agent-badge">{{
                    agent.id.includes('main') ? 'F≈ê' : 'SUB'
                  }}</span> -->
                </div>
                }

                <!-- Accordion panel for chats of this task -->
                <div class="agent-panel open">
                  <div class="search"></div>
                  <div class="items">
                    @if (isLoadingChats()) {
                    <div class="hint">Besz√©lget√©sek bet√∂lt√©se...</div>
                    } @else { @for (c of taskChats(); track c.id) {
                    <div
                      class="itm"
                    
                      [class.active]="activeChat()?.id === c.id"
                      (click)="setActiveChatForTask(task.id, c.id)"
                    >
                      <strong>{{ c.title }}</strong>
                      <small>{{ c.ts }}</small>
                      <div class="hint">{{ c.preview }}</div>
                    </div>
                    } @if (!taskChats().length) {
                    <div class="hint">
                      Ehhez a feladathoz nincs besz√©lget√©s.
                    </div>
                    } }
                  </div>
                </div>
                } }
              </div>
              }
            </div>
            <!-- <div
              class="plus"
              (click)="showAgentModal.set(true)"
              role="button"
              style="margin-top: 10px"
              tabindex="0"
              aria-label="Almunkat√°rs hozz√°ad√°sa"
            >
              <strong>Ôºã Almunkat√°rs hozz√°ad√°sa</strong>
            </div>
            <p class="hint">
              Kattints egy munkat√°rsra a besz√©lget√©seinek megnyit√°s√°hoz.
              Egyszerre csak egy munkat√°rs lehet lenyitva.
            </p> -->
          </div>
        </div>
      </aside>

      <!-- CENTER: Csak thread + composer -->
      <section class="panel" aria-label="Cseveg≈ë konzol" style="flex: 2">
        <div class="chatwrap">
          <!-- <div class="chat-header">
            <div>
              @if (currentAgent()) {
              <div class="pill">Akt√≠v: {{ currentAgent()!.name }}</div>
              <div class="hint">{{ currentAgent()!.desc }}</div>
              } @else if (isLoadingAgents()) {
              <div class="pill">Bet√∂lt√©s...</div>
              <div class="hint">Munkat√°rsak bet√∂lt√©se folyamatban</div>
              } @else {
              <div class="pill">Nincs akt√≠v munkat√°rs</div>
              <div class="hint">V√°lassz egy munkat√°rst a bal oldali list√°b√≥l</div>
              }
            </div>
            @if (currentAgent() && currentAgent()!.id==='root') {
            <div class="quick">
              <button
                pButton
                label="Munkat√°rs l√©trehoz√°sa"
                class="p-button-sm"
              ></button>
              <button
                pButton
                label="Felhaszn√°l√≥k kezel√©se"
                class="p-button-sm p-button-outlined"
              ></button>
              <button
                pButton
                label="Konnektor hozz√°ad√°sa"
                class="p-button-sm p-button-outlined"
              ></button>
              <button
                pButton
                label="Egyedi konnektor ig√©ny"
                class="p-button-sm p-button-outlined"
              ></button>
              <button
                pButton
                label="Munka √ºtemez√©se"
                class="p-button-sm p-button-outlined"
              ></button>
              <button
                pButton
                label="SF csapattal kapcsolatfelv√©tel"
                class="p-button-sm p-button-outlined"
              ></button>
            </div>
            }
          </div> -->

          <!-- Thread -->
          <div class="thread" aria-live="polite">
            <div class="messages" style="max-height: 900px">
              @if (activeChat()) { @for (m of activeChat()!.messages; track
              $index) {
              <div
                class="message-container"
                [ngClass]="{
                  user: m.from === 'user',
                  agent: m.from === 'agent'
                }"
              >
                @if (m.from === 'agent') {
                <div class="message-avatar">
                  <div class="avatar-circle">
                    {{ currentAgent()?.name?.[0] | uppercase }}
                  </div>
                </div>
                }
                <div class="message-content">
                  <div
                    class="message-bubble"
                    [ngClass]="{
                      'user-bubble': m.from === 'user',
                      'agent-bubble': m.from === 'agent'
                    }"
                  >
                    <div class="message-text">{{ m.text }}</div>
                  </div>
                  @if (m.from === 'agent') {
                  <!-- <div class="message-actions">
                    <button class="action-btn" title="M√°sol√°s">
                      <i class="pi pi-copy"></i>
                    </button>
                    <button class="action-btn" title="T√∂k√©letes">
                      <i class="pi pi-thumbs-up"></i>
                    </button>
                    <button class="action-btn" title="Nem j√≥">
                      <i class="pi pi-thumbs-down"></i>
                    </button>
                  </div> -->
                  }
                </div>
                @if (m.from === 'user') {
                <div class="message-avatar user-avatar">
                  <div class="avatar-circle user-avatar-circle">
                    <i class="pi pi-user"></i>
                  </div>
                </div>
                }
              </div>
              } } @else {
              <div class="empty-state">
                <div class="empty-icon">
                  <i
                    class="pi pi-comments"
                    style="font-size: 3rem; color: var(--muted)"
                  ></i>
                </div>
                <div class="empty-text">
                  V√°lassz besz√©lget√©st bal oldalt vagy √≠rj √ºzenetet √∫j thread
                  ind√≠t√°s√°hoz.
                </div>
              </div>
              }

              <!-- Skeleton loading while waiting for response -->
              @if (isSendingMessage() && !isStreaming()) {
              <div class="message-container agent skeleton">
                <div class="message-avatar">
                  <div class="avatar-circle">
                    {{ currentAgent()?.name?.[0] | uppercase }}
                  </div>
                </div>
                <div class="message-content">
                  <div class="message-bubble agent-bubble">
                    <div class="skeleton-text">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                      <div class="skeleton-line medium"></div>
                    </div>
                  </div>
                  <div class="message-actions">
                    <span class="typing-indicator">V√°lasz el≈ëk√©sz√≠t√©se...</span>
                  </div>
                </div>
              </div>
              }

              <!-- Streaming response -->
              @if (isStreaming() && streamingResponse()) {
              <div class="message-container agent">
                <div class="message-avatar">
                  <div class="avatar-circle">
                    {{ currentAgent()?.name?.[0] | uppercase }}
                  </div>
                </div>
                <div class="message-content">
                  <div class="message-bubble agent-bubble">
                    <div class="message-text streaming-text">
                      {{ streamingResponse() }}
                      <span class="streaming-cursor">|</span>
                    </div>
                  </div>
                  <div class="message-actions">
                    <span class="typing-indicator">√çr...</span>
                    @if (currentTask()?.processed_file_path) {
                      <button 
                        pButton 
                        type="button"
                        class="p-button-text p-button-sm download-btn"
                        icon="pi pi-download"
                        (click)="downloadProcessedFile()"
                        title="Feldolgozott f√°jl let√∂lt√©se"
                        aria-label="Feldolgozott f√°jl let√∂lt√©se"
                      ></button>
                    }
                  </div>
                </div>
              </div>
              }

              <!-- Streaming error -->
              @if (streamingError()) {
              <div class="message-container agent error">
                <div class="message-content">
                  <div class="message-bubble agent-bubble error-bubble">
                    <div class="message-text">
                      <i
                        class="pi pi-exclamation-triangle"
                        style="margin-right: 8px"
                      ></i>
                      {{ streamingError() }}
                    </div>
                  </div>
                </div>
              </div>
              }
            </div>
            <div class="composer" style="justify-content: center">
              <div
                style="
                  width: 100%;
                  position: relative;
                  justify-content: center;
                  max-width: 800px;
                "
              >
                <div 
                  class="textarea-container"
                  [class.drag-over]="isDragOver()"
                  (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)"
                  (drop)="onDrop($event)"
                >
                  <textarea
                    pTextarea
                    placeholder="Oldj meg egy feladatot‚Ä¶ vagy h√∫zz ide egy .txt f√°jlt"
                    #composer
                    [ngModel]="messageText()"
                    (ngModelChange)="messageText.set($event)"
                    style="height: 124px; width: 100%"
                    aria-label="√úzenet"
                  ></textarea>
                  
                  <!-- Felt√∂lt√∂tt f√°jl megjelen√≠t√©se -->
                  @if (uploadedFile()) {
                    <div class="uploaded-file">
                      <i class="pi pi-file"></i>
                      <span>{{ uploadedFile()?.name }}</span>
                      <button 
                        type="button" 
                        class="remove-file-btn"
                        (click)="removeUploadedFile()"
                        aria-label="F√°jl elt√°vol√≠t√°sa"
                      >
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  }
                </div>
                <button
                  pButton
                  class="p-button-sm accent button--bordered"
                  [class.sending]="isSendingMessage()"
                  style="
                    position: absolute;
                    right: 10px;
                    bottom: 15px;
                    height: 40px;
                    width: 40px;
                    border-radius: 50%;
                  "
                  (click)="sendMessage(composer)"
                  [disabled]="!messageText().trim() || isSendingMessage()"
                >
                  @if (isSendingMessage()) {
                  <i class="pi pi-spin pi-spinner"></i>
                  } @else {
                  <i class="pi pi-send"></i>
                  }
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Settings (per active agent) -->
      <aside
        class="panel right-aside-closed"
        [class.right-aside-open]="isRightAsideOpen()"
        [class.right-aside-closed]="!isRightAsideOpen()"
        aria-label="Munkat√°rs be√°ll√≠t√°sok"
      >
        <h2>
          <span class="heading">Munkat√°rs be√°ll√≠t√°sok</span>
          <span class="pill">{{ tasks().length }} feladat</span>
        </h2>
        <div class="content">
          @if (currentAgent()) {
          <div class="section">
            <h3>
              <span>Instrukci√≥k</span>
              <button
                pButton
                icon="pi pi-plus"
                (click)="addInstruction()"
                class="p-button-text p-button-sm"
                title="√öj instrukci√≥"
                aria-label="√öj instrukci√≥"
              ></button>
            </h3>
            <div class="body">
              @for (i of currentAgent()!.settings?.instructions; track i.title)
              {
              <div class="chip-container">
                <span class="chip" [class.new-chip]="i.isNew === true">{{
                  i.title
                }}</span>
                <button
                  class="chip-delete-btn"
                  (click)="deleteInstruction(i.title)"
                  title="Instrukci√≥ t√∂rl√©se"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>
              }
            </div>
          </div>
          <div class="section">
            <h3>
              <span>Alkalmaz√°sok</span>
              <button
                pButton
                icon="pi pi-plus"
                class="p-button-text p-button-sm"
                title="√öj alkalmaz√°s"
                aria-label="√öj alkalmaz√°s"
                (click)="addApp()"
              ></button>
            </h3>
            <div class="body">
              @for (i of currentAgent()!.settings?.apps; track i.title) {
              <div class="chip-container">
                <span class="chip" [class.new-chip]="i.isNew === true">{{
                  i.title
                }}</span>
                <button
                  class="chip-delete-btn"
                  (click)="deleteApp(i.title)"
                  title="Alkalmaz√°s t√∂rl√©se"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>
              }
            </div>
          </div>
          <div class="section">
            <h3>
              <span>Er≈ëforr√°sok</span>
              <button
                pButton
                icon="pi pi-plus"
                class="p-button-text p-button-sm"
                title="√öj er≈ëforr√°s"
                aria-label="√öj er≈ëforr√°s"
                (click)="addResource()"
              ></button>
            </h3>
            <div
              class="body"
              (dragover)="onDragOverSection($event, 'resources')"
              (dragleave)="onDragLeaveSection($event)"
              (drop)="onDropSection($event, 'resources')"
              [class.drag-over]="
                isDragOver() && dragOverSection() === 'resources'
              "
            >
              @if (isDragOver() && dragOverSection() === 'resources') {
              <div class="drop-zone-hint">
                <i
                  class="pi pi-cloud-upload"
                  style="font-size: 1.5rem; color: var(--accent-2)"
                ></i>
                <p>H√∫zd ide a txt f√°jlokat (max 5MB)</p>
              </div>
              } @for (i of currentAgent()!.settings?.resources; track i.title) {
              <div class="chip-container">
                <span class="chip" [class.new-chip]="i.isNew === true">{{
                  i.title
                }}</span>
                <button
                  class="chip-delete-btn"
                  (click)="deleteResource(i.title)"
                  title="Er≈ëforr√°s t√∂rl√©se"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>
              }
            </div>
          </div>
          <p class="hint">
            A be√°ll√≠t√°sok **az akt√≠v munkat√°rshoz** tartoznak. A ‚ÄûÔºã" gombokkal
            adhatsz hozz√° √∫j elemeket.
          </p>
          } @else if (isLoadingAgents()) {
          <div class="section">
            <h3>
              <span>Bet√∂lt√©s...</span>
            </h3>
            <div class="body">
              <div class="hint">
                Munkat√°rs be√°ll√≠t√°sok bet√∂lt√©se folyamatban...
              </div>
            </div>
          </div>
          } @else {
          <div class="section">
            <h3>
              <span>Nincs akt√≠v munkat√°rs</span>
            </h3>
            <div class="body">
              <div class="hint">
                V√°lassz egy munkat√°rst a bal oldali list√°b√≥l a be√°ll√≠t√°sok
                megtekint√©s√©hez.
              </div>
            </div>
          </div>
          }
        </div>
      </aside>
    </div>
  </main>

  <!-- Agent Modal -->
  <p-dialog
    [visible]="showAgentModal()"
    [modal]="true"
    [style]="{ width: '720px' }"
    header="√öj almunkat√°rs"
    (onHide)="showAgentModal.set(false)"
    aria-label="√öj almunkat√°rs mod√°l"
  >
    <div class="grid formgrid p-fluid">
      <div class="field col-12">
        <label for="name" class="text-sm">N√©v</label>
        <input
          id="name"
          pInputText
          placeholder="Pl. P√©nz√ºgyi Elemz≈ë"
          required
        />
      </div>
      <div class="field col-12">
        <label for="role" class="text-sm">Szerepk√∂r</label>
        <select id="role" pInputText>
          <option>Elemz≈ë</option>
          <option>Asszisztens</option>
          <option>Fejleszt≈ë</option>
          <option>Oper√°tor</option>
        </select>
      </div>
      <div class="field col-12">
        <label for="desc" class="text-sm">Le√≠r√°s</label>
        <textarea
          id="desc"
          pTextarea
          rows="3"
          placeholder="R√∂vid bemutatkoz√°s, felel≈ëss√©gek, hat√≥k√∂r‚Ä¶"
        ></textarea>
      </div>
      <div class="field col-12">
        <label for="cfg" class="text-sm">Konfigur√°ci√≥ (.json vagy .txt)</label>
        <textarea
          id="cfg"
          pTextarea
          rows="6"
          placeholder='{"mcpServers":[], "tools":["email","sql","writer","calc","pdf","imageIngest"], "policy":"read-write"}'
        ></textarea>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <button
        pButton
        label="M√©gse"
        class="p-button-text"
        (click)="showAgentModal.set(false)"
      ></button>
      <button
        pButton
        label="Ment√©s"
        icon="pi pi-check"
        class="p-button"
        (click)="showAgentModal.set(false)"
      ></button>
    </ng-template>
  </p-dialog>
</div>
